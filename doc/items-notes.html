<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<!-- always required -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<!-- needed for sequence diagrams -->
<script type="text/javascript" src='http://talentappstore.github.io/tas-des-static/js/raphael-min.js'></script>
<script type="text/javascript" src='http://talentappstore.github.io/tas-des-static/js/underscore-min.js'></script>
<script type="text/javascript" src='http://talentappstore.github.io/tas-des-static/js/sequence-diagram-min.js'></script>
<script type="text/javascript" src='http://talentappstore.github.io/tas-des-static/js/sequence-diagram-wrapper.js'></script>

<!-- needed for includes -->
<script type="text/javascript" src='http://talentappstore.github.io/tas-des-static/js/clientInclude.js'></script>

<!-- needed for table of contents -->
<script type="text/javascript" src='http://talentappstore.github.io/tas-des-static/js/tocify.js'></script>

<!-- always required -->
<link rel='stylesheet' href='http://talentappstore.github.io/tas-des-static/css/des.css' type='text/css' media='all' />


<title>Design notes on items and file uploads and downloads</title>
</head>
<body>

<h1>About items</h1>

<p>Items are user-defined fields, held against major objects such as jobs, candidates, or their job application(s); for example "Are you legally allowed to work in Australia?".
</p>

<p>Items have a type, as described by an extension variant of <a href='http://json-schema.org/'>json schema</a> - for example, the item above
would be a yes/no item. Other types include free text, document upload, multi-choice and others.  
</p>

<p>Items may be required from the candidate when they apply for a job, or register. In this case, the required items are laid out in the itemsRule element of the
candidateModel or applicationModel of the edit spec, e.g.:

<ul>
<li>if applying for a job based in Australia, candidate may be asked "what is your eligibility to work in Australia?"
<li>if registering interest in financial advisor jobs in NZ, candidate might need to upload an industry certification.
</ul>
</p>

<p>The items required when applying or registering may vary by candidate or other factors, e.g.:  

<ul>
<li>if applying for a job, and the candidate is internal, they may be asked "have you checked with your manager?"
<li>if applying on a smartphone, then a reduced set of questions may be asked
<li>if applying for a job, and the candidate has already been pre-vetted (e.g. employee referral perhaps in-store)
then they may get a truncated application form
</ul>
</p>

<h1>Item schema</h1>

<p>Items are described by an extension variant of <a href='http://json-schema.org/'>json schema</a>, where each item is a property. The extensions are described below.
</p>

<h2>description</h2>

<p>Item descriptions are formatted using a safe subset of [markdown](https://daringfireball.net/projects/markdown/syntax),
with individual lines demarcated with \n.
</p>
 
<p>Currently, "safe subset" simply means that angle brackets (&lt; or &gt;) are not allowed.
Note that this prevents the markdown blockquote syntax from being used in a job description, or text like
"candidates must have >10 years experience". The safe subset rules may be relaxed in the future to allow
these cases.
</p>

<h2>propertyOrder</h2>

<p>When a set of properties (items) is described in a single aggregating schema (e.g. the itemsRule element of an edit spec), then each property
can have a propertyOrder property, which acts as per as per https://github.com/jdorn/json-editor#property-ordering.
This should be used to control the property's display order <b>within their enclosing object</b>, e.g.:
<div class='codeBlock'>
"firstName": {
   "type": "string",
   "access": "candidateOwned",
   "propertyOrder": 1001
}
</div>
</p>

<p>propertyOrder is really a presentation hint that is sometimes injected into the item's schema. Fetching the itemMeta for an item will not include it. 
</p>

<h2>access</h2>

<p>Individual items must have an "access" property, which is one of:
<ul>
<li>candidateOwned
<li>internalOwned
<li>internalShared
<li>eeo
</ul>

<p>Access should only be specified on actual items, not on grouping objects, and should only be specified
on top level properties (i.e. not on properties within an array). 
</p>

<h2>Special TAS formats for type=object</h2>

<p>In json schema, items of type "object" can specify a "format" to further describe their appearance and behaviour.
</p>

<p>TAS defines a number of these formats, as listed below.
</p>

<h3>tas-fileupload</h3>

<p>Used for file uploads, i.e. data about to be applied to the server. Items using this format must have a list of properties
exactly matching fileUpload.json schema.</p>

<p>The additional, optional property "accept" can be used to limit the allowable file formats (as a comma separated list of mime types).

<div class='codeBlock'>
{
    "coverLetter": {
        "type": "object",
        "propertyorder": 100,
        "format": "tas-fileUpload",
        "access": "candidateOwned",
        "accept": [ "image/png", "text/html" ],
        "description": "Please upload a cover letter. The shorter the better",
        "properties": {
            "data": {
                "type": "string",
                "media": {
                    "binaryEncoding": "base64"
                }
            },
            "fileName": {
                "type": "string"
            },
            "via": {
                "type": "string"
            }
        }
    }
}</div>
</p>

<h3>tas-enumdetails</h3>

<p>Used to handle situations such as yes/no/details.
</p>


<h2>Arrays</h2>

<p>Items can be arrays (i.e. table questions, such as "which of the following do you have experience in?"). For array to be
valid, we require that:
<ul>
<li>Tuple typing must not be used
<li>Arrays are not nested (only one level of arrays)
<li>In the schema for the array items:
<ul>
<li>Array items must be of object type
<li>one and only one property within the array item must have the extension "primaryKey" value set to true
<li>that property must be required
<li>the special property "itemOp" must be present
<li>it must be an enum of ["add", "replace", "remove"]
<li>it must be required
</ul>
</ul>


<h1>Handling incoming items (producing POST /candidates/me)</h1>

<p>This section describes how a producer of POST /candidates/me should process the incoming stream of item data, which may
include presentation-level information (such as grouping of items) that must be stripped out beofre processing the base items themselves.
</p>

<p>The steps are:
<ol>
<li>Re-fetch the edit spec
<li>Strip out root and branches of the json object structure, leaving only leaves, except for objects with format=tas-XXX.
</ol>
These steps are described below:
</p>   

<h2>Re-fetch the edit spec</h2>

<p>To process the incoming items, the producer of POST /candidates first must fetch an edit spec. The result will
likely be the same edit spec the consumer fetched earlier to build the UI that the candidate used to enter the
items (e.g., the application form to apply for a job).
</p>

<p>Every item in the incoming items section should be validated against its matching entry in the editSpec's itemsRule section.
If an incoming item does not have a matching entry in the edit spec, this could indicate a malicious app trying to write to
an item it does not have access to, and the edit should be failed.
</p>

<h2>Strip out object structure</h2>

<p>Clients may send up a bunch of item data that contains presentation information (like grouping) that needs to be stripped out. 
</p>

<p>Firstly, any object structure in the incoming items is removed. So this..
<div class='codeBlock'>
{
    "Eligibility": {
        "Years in industry": 28.2,
        "Able to lift heavy objects": true
    },
    "Availability": {
        "Shift details": {
            "Shift work": "Yes, any hours"
        }
    }
}
</div>

<p>..becomes this..
<div class='codeBlock'>
{
    "Years in industry": 28.2,
    "Able to lift heavy objects": true,
    "Shift work": "Yes, any hours"
}
</div>
<p>

<h3>Preserve object structure for format=tas objects</h3>

<p>An exception to the above is when the edit spec shows format=tas-upload or tas-enum for an object. In that case, the object 
represents a single item, but one that has multiple fields. e.g. If items is like this..
<div class='codeBlock'>
{
    "Eligibility": {
        "Years in industry": 28.2,
        "Able to lift heavy objects": true
    },
    "Availability": {
        "Shift details": {
            "Shift work": "Yes, any hours"
        }
    },
    "coverLetter": {
       "data": "iu7g6xswqs6216Ug564fojho7if8dfi876GKJH..",
       "fileName": "coverletter.docx",
       "via": "dropbox.com"
}
</div>
</p>

<p>
.. and the matching entry for cover letter in itemsRule is like this..
<div class='codeBlock'>
{
    "type": "object",
    "format": "tas-fileUpload",
    "accept": "image/png,text/html",
    "description": "Please upload a cover letter. The shorter the better",
    "properties": {
        "data": {
            "type": "string",
            "media": {
                "binaryEncoding": "base64"
            }
        },
        "fileName": {
            "type": "string"
        },
        "via": {
            "type": "string"
        }
    }
}
</div>
</p>

<p>Then after processing there will be 3 items to process, one of which is multi-valued:
<div class='codeBlock'>
{
    "Years in industry": 28.2,
    "Able to lift heavy objects": true,
    "Shift work": "Yes, any hours",
    "coverLetter": {
        "data": "iu7g6xswqs6216Ug564fojho7if8dfi876GKJH..",
        "fileName": "coverletter.docx",
        "via": "dropbox.com"
    }
}
</div>
</p>

<h2>Handling arrays</h2>

<p>The items section can contain arrays, e.g.:
<div class='codeBlock'>
{
    "specific experience": [
        {
            "type": "Food handling",
            "years": 1.5
        },
        {
            "type": "Cash handling",
            "years": 1
        }
    ]
}
</div>
</p>

<p>For the items section to be valid, we require that:
<ul>
<li>In the items, when the property "itemOp" has a value of "add", the value for the primary key property must be null (since primary keys are
generated by the server).
</ul>


<script>
$(document).ready(function() {

	renderSequenceDiagrams();
	renderClientIncludes();
	renderTOC();
});
</script>


</body>
</html>