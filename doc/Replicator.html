<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script type="text/javascript" src='http://tas-des-static.talentappstore.com/js/raphael-min.js'></script>
<script type="text/javascript" src='http://tas-des-static.talentappstore.com/js/underscore-min.js'></script>
<script type="text/javascript" src='http://tas-des-static.talentappstore.com/js/sequence-diagram-min.js'></script>
<script type="text/javascript" src='http://tas-des-static.talentappstore.com/js/tocify.js'></script>

<link rel='stylesheet' href='http://tas-des-static.talentappstore.com/css/des.css' type='text/css' media='all' />


<title>Replicator</title>
</head>
<body>




<h1>Message sequence diagram for installing a new app "ferret" that is a replication secondary for candidates (i.e., a CV search type app).</h1>

<div class='seqdiag' id="repexample" style="display:none;">

participant ats
participant ferret
participant repstate
participant TAS

note left of TAS: tenant acme installs the ferret app
TAS->ferret: POST /tenants/acme
note left of ferret: ferret knows it is a replication\nsecondary for candidates,\ninitializes the replication state store
ferret->repstate: POST /repstates/ferret/tas/%2Fcandidates\n{"loading"":true,lastLoaded:null}
note left of ferret: ferret asks for id of first candidate
ferret->ats: GET /candidates?$orderby=id&$select=id&$top=1
note right of ats: ats says 10234
note left of ferret: ferret calls its own onPing() method\nwhich fetches full details from the primary
ferret->ats: GET /candidates/10234?$select=resume
note right of ats: ats passes back resume
ferret->repstate: POST /repstates/ferret/tas/%2Fcandidates\n{"loading"":true,lastLoaded:10234}

note left of ferret: ferret asks for id of next candidate
ferret->ats: GET /candidates?$orderby=id&$select=id&$top=1&$filter=id gt 10234
note right of ats: ats says 10235
ferret->ats: GET /candidates/10235?$select=resume
note right of ats: ats passes back resume
ferret->repstate: POST /repstates/ferret/tas/%2Fcandidates\n{"loading"":true,lastLoaded:10235}

note right of ats: ..time passes..

note right of ats: a database trigger fires in the ats,\nreflecting that a new candidate has been created
note right of ats: this is the first time that ats\nhas tried to broadcast\nto this API for tenant acme,\nso asks TAS who produces that API
ats->TAS: GET /tenants/acme/routes/ats/tas/%2Fm%2Fcandidates%2F%7BcandidateID%7D%2FdeltaPings
note left of TAS: TAS says:\n"items": [{"producer": "ferret",\n"location": "https://acme.ferret.com/api/v3.2"},..]
note right of ats: ats now sends message to say\nthat a new candidate has been created
ats->ferret: POST /m/candidates/29046/deltaPings\n{"operation": "insert"}
note right of ferret: to decide whether to ignore the ping,\nferret needs to know the current\nstate of the replication secondary.\nIt could have this in memory or it\nit may be easier for the API handler\nto fetch it from the replication status store.
ferret->repstate: GET /repstates/ferret/tas/%2Fcandidates\n{"loading"":true,lastLoaded:10235}
note left of ferret: ferret onPing()\nif (!loading || id <= lastID) absorbPing();\nignores the ping

note left of ferret: ferret asks for id of next candidate
ferret->ats: GET /candidates?$orderby=id&$select=id&$top=1&$filter=id gt 10235
note right of ats: ats says 404 error
note left of ferret: replication bulk load is complete
ferret->repstate: POST /repstates/ferret/tas/%2Fcandidates\n{"loading"":false,lastLoaded:null}
</div>



<h1>INCOMPLETE: Message sequence diagram for ATS broadcasting pings about new candidates to any interested apps</h1>

<p>The <b>broadcast service</b> is a stand-alone web service that handles the heavy lifting of broadcasting
calls to non-SoT APIs (e.g. pings) to all producing apps.</p>

<p>The broadcast service is implemented as a stand-alone web service rather than a library as
it requires a persistent queue to store outgoing messages and handle error reties, etc.</p> 


<div class='seqdiag' id="disruptionexample" style="display:none;">

participant ats
participant broadcast service
participant ferret
participant TAS
note left of ferret: tenant acme installs the ferret app,\ninitiating the "disruption dance"
TAS->ats: POST /tenants/acme/halts
note right of ats: ats tells the broadcast service to\nclear its caches since the\nworld is about to go upside down
TAS->ferret: POST /tenants/acme
TAS->ferret: POST /tenants/acme/starts
TAS->ats: POST /tenants/acme/starts
note right of ferret: ferret install is complete,\ndisruption is over
note right of ats: a database trigger fires in the ats,\nreflecting that a new candidate has been created
note right of ats: the ats composes a request body,\nand instructs the broadcast service to\nbroadcast it to all producers of a specific API. This\nhappens via a (non-TAS) API call
ats->broadcast service: POST broadcast.com/broadcasts/tas/\n%2Fm%2Fcandidates%2F%7BcandidateID%7D%2FdeltaPings
note right of ats: Request:\n{"params": {"candidateID": 100},\n"requestBody": {"operation": "insert"}}
note right of ats: broadcast service can make\ncore API\ncalls on ats's behalf, but this is\nthe first time that ats has tried to broadcast\nto this API for tenant acme,\nso asks TAS who produces that API
broadcast service->TAS: GET /tenants/acme/routes/ats/tas/%2Fm%2Fcandidates%2F%7BcandidateID%7D%2FdeltaPings
note left of TAS: TAS says:\n"items": [{"producer": "ferret",\n"location": "https://acme.ferret.com/api/v3.2"},..]
broadcast service->ferret: POST /m/candidates/29046/deltaPings\n{"operation": "insert"}
</div>




<h1>Display the UberApply button on a job details page in the ATS</h1>
<ul>
<li>Candidate sees a posting for a specific job on some media (e.g. Facebook)
<li>Candidate clicks on a link within the posting and is lead to the job details page in the ATS.
<li>The job details page contains the UberApply button
<li>The candidate can click on the UberApply button to complete a job application
<li>UberApply pushes the completed job application out via REST API call (perhaps to the ATS)
<li>..additional complication..
<li>The original URI the user clicked on contained additional sourcing information in the form of query parameters (e.g., "&source=facebook").
<li>Those additional parameters need to also be passed through within the REST call for the completed job application
<li>Therefore they need to somehow be passed "through" the UberApply tunnel
<li>The mechanism that supports this is the Tracker
</ul>

<p>Note: it could be instead that the ATS ()or whatever system creates the links within the postings already uses Tracker.
In that case, the URI in the posting would have been like this:
<code>https://acme.jobboard.com/jobs/7622?tas_tracker=87602231</code>
In this case the ATS would not have needed to do anything with Tracker, since that work has already been done.
</p>


<div id="diagram1Source" style="display:none;">
Candidate browser->ATS: GET /jobDetails?job=100234?source=facebook

ATS->Tracker: GET /destinationTrackers?type=jobs\n&id=7622\n&uri=/jobDetails/job=100234?source=facebook\n&meta=source:facebook

note right of Tracker: Response: 200\nLocation: 763020034

ATS->Tracker: GET /visitorTrackers?parentTracker=763020034\n&landingURI=https://acme.jobboard.com/jobs/7622?candidateSource=facebook\n&referer=https://www.facebook.com\n&userAgent=Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36\n(KHTML, like Gecko) Chrome/37.0.2049.0 Safari/537.36\n&ipAddress=20.12.34.102\n&acceptLanguage=en-us,en;q=0.5

note right of Tracker: Response: 200\nLocation: 763019932

note right of ATS: ATS asks for the html containing\nUberApply button so it\ncan insert it into the job details page.\nIf the candidate is logged in\nthen the ATS hints to UberApply that it should\nimmediately ask the candidate to log in also.   

ATS->Button aggregator: GET /positionOpenings/{7622}/candidateActionBar?tas_tracker=763019932\n&force_login=true

note left of Button aggregator: Response:\nblah html blah iframe src=uberapply force_login=true

</div>


<h1>Click and apply using UberApply</h1>
 

<h1>helloworld app makes an OAuth protected call to another app, which then extracts the SAMLIdentity</h1>

<div id="diagram2Source" style="display:none;">


helloworld->TAS: GET /apps/{helloworld}/tenants/{acme}/accessors/{GET}/{tas}/{URI template}
</div>


Additional APIs from Jeff's email
       addApi("Requisitions", "/requisitions", "GET", true);
        addApi("Requisition", "/requisitions/{id}", "GET", true);
        addApi("Apply", "/apply/requisitions/{id}", "GET", true);
        addApi("Apply Experiences", "/candidateEventPoints/requisitions/{id}/applyExperiences", "GET", true);
        addApi("Candidate Event Points", "/candidateEventPoints/requisitions/{id}/events", "POST", true);
        addApi("Candidate Action Bar", "/requisitions/{id}/candidateActionBar", "GET", true);
        addApi("Candidate Action Item", "/requisitions/{id}/candidateActionItem", "GET", false);
        addApi("Application", "/requisitions/{requisitionId}/candidates/{candidateId}/application", "GET", true);


<div id="diagram2Source" style="display:none;">
note right of samler: User fred logs in at the ATS.\nsamler is listening to\nlogins, and adds Fred\nto its users table on the fly\nbefore passing the assertion through
samler->hub: POST /SAMLIdentities/{users}/100245 (blocking)
hub->ATS:  POST /SAMLIdentities/{users}/100245
note right of ATS: ATS provisions user Fred,\ni.e creates a row in is own\n users table
</div>

<h1>Message sequence diagram for installing a new app that is a replication secondary for candidates (i.e., a CV search type app).</h1>

<div class='seqdiag' id="apitypes" style="display:none;">

participant ATS
participant zoom
participant replicator
participant corehub
participant TAS
note left of TAS: tenant acme installs\nthe zoom app
note left of TAS: zoom has delegated\ncorehub to handle its\nincoming TAS core API messages
TAS->corehub: POST /apps/{zoom}/t/{acme}
note left of TAS: TAS passes 71222 as the\nbringup id that zoom\nshould use when its ready
note right of corehub: corehub knows it needs\nto pass core API messages\non to both zoom itself\nand replicator
corehub->zoom: POST /apps/{zoom}/t/{acme}
corehub->replicator: POST /apps/{zoom}/t/{acme}
note right of zoom: zoom has finished already
zoom->corehub: POST /bringups/{71222}
note right of replicator: replicator will take way longer
note right of replicator: replicator knows that zoom\nis a secondary for /candidateShips.\nAsks who is SoT.
replicator->TAS: GET /produces/tas/candidateShips
note left of TAS: TAS says "ATS"
note right of replicator: replicator asks for highwater id
replicator->ATS: GET /candidateShips?fields=id,order=id,limit=1
note right of ATS: ATS says 10234
note right of replicator: replicator fetches first stripe
replicator->ATS: GET /candidateShips?fields=id,order=id,limit=30,filter=id>0
note right of ATS: ATS passes back first 30 ids\n{10,12,14,15,...45}
note right of replicator: replicator tricks zoom into\nfetching first candidateShip (id==10)
replicator->zoom: POST /candidateShips/{10}/deltaPings
note right of zoom: zoom doesn't need to\nknow that it was replicator\nthat sent the delta ping,\nnot ATS
zoom->ATS: GET /candidateShips/{10}
note right of replicator: and so on (id==12)
replicator->zoom: POST /candidateShips/{12}/deltaPings
zoom->ATS: GET /candidateShips/{12}
note right of replicator: until last id (id==45)
replicator->zoom: POST /candidateShips/{45}/deltaPings
zoom->ATS: GET /candidateShips/{45}
note right of replicator: replicator fetches next stripe
replicator->ATS: GET /candidateShips?fields=id,order=id,limit=30,filter=id>45
note right of ATS: ATS passes back next 30 ids\n{46,48,50,...123}
note right of replicator: replicator eventually reaches\nthe high water mark
replicator->zoom: POST /candidateShips/{10234}/deltaPings
zoom->ATS: GET /candidateShips/{10234}
note right of replicator: replicator is now fully up to date,\ntells corehub
replicator->corehub: POST /bringups/{71222}
note right of corehub: corehub now has a full\nset of bringups, can\ngo back to TAS
corehub->TAS: POST /bringups/{71222}
note left of TAS: replication bulk load\nphase is now complete
</div>



<script>
function render(obj) {
	// we first need to encode away the &gt; and &lt; chars we get back
	var e = document.createElement('div');
	e.innerHTML = $(obj).html();
	
	// create a div to hold the diagram
	$(obj).after("<div id='" + $(obj).attr('id') + "-diag'></div>");

	// then create diagram
	var diagram = Diagram.parse(e.childNodes[0].nodeValue);
	diagram.drawSVG($(obj).attr('id') + '-diag', {theme: 'simple'});
}	

$(document).ready(function() {

    //Executes your code when the DOM is ready.  Acts the same as $(document).ready().
    //Calls the tocify method on your HTML div.
//$("#toc").tocify();
	
	$('.seqdiag').each(function(i, obj) {
	    render(obj);
	});

	tocify('toc');
	
});
</script>


</body>
</html>